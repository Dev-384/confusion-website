<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>■■■■■ | Confusion Studio</title>
		<link rel="stylesheet" href="/styles/theme.css">
		<link rel="stylesheet" href="/styles/dashboard.css">
		<link rel="shortcut icon" href="/assets/favicon.png" type="image/*">
		<style>
			nav {
				animation: hide 750ms forwards;
			}

			@keyframes hide {
				from {
					translate: 0 0;
				}

				to {
					translate: 0 -100%;
				}
			}
		</style>
	</head>

	<body>

		<template from="/components" id="theme-change-cover"></template>

		<template from="/components" id="nav"></template>

		<script src="/index.js" type="module" defer></script>

		<script type="module">
			import * as components from "https://waitimconfused.github.io/confusion-projects/game-engine/components/index.js";
			import { animation, engine } from "https://waitimconfused.github.io/confusion-projects/game-engine/utils.js";
			import { mouse } from "https://waitimconfused.github.io/confusion-projects/toolbelt/toolbelt.js";

			console.log(engine);
			engine.disableZoom();

			const colourPickerSize = screen.pixelDepth * 20;

			const projectName = ( new URLSearchParams(window.location.search) ).get("p");
			document.querySelector("title").innerText = document.querySelector("title").innerText.replace("■■■■■", projectName);

			var db;
			var editor;

			let request = indexedDB.open("projectsDB", 1);

			request.onsuccess = function (event) {
				db = event.target.result;
				console.log(db);
				init();
			};

			request.onerror = function (event) {
				console.error("Database error: " + event.target.errorCode);
			};

			function generateHueSelector(quality=500, thickness=quality/10) {
				const colourPicker = document.createElement("canvas");
				const colourPickerContext = colourPicker.getContext("2d");

				colourPicker.width = quality;
				colourPicker.height = quality;

				const center = quality / 2;

				for (let i = 0; i < 360; i += 1) {
					let point1 = pointOnCircle(i, center - thickness, center, center);
					let point2 = pointOnCircle(i, center, center, center);
					colourPickerContext.beginPath();
					let hue = -i;
					hue %= 360;
					if (hue < 360) hue += 360;
					colourPickerContext.strokeStyle = `hsl(${hue}deg, 100%, 50%)`;
					colourPickerContext.lineWidth = quality / 100;
					colourPickerContext.moveTo(point1.x, point1.y);
					colourPickerContext.lineTo(point2.x, point2.y);
					colourPickerContext.closePath();
					colourPickerContext.stroke();
				}

				return colourPicker.toDataURL();
			}

			var hueSelectorURL = generateHueSelector(colourPickerSize);

			function pointOnCircle(deg = 0, scale = 1, anchorX = 0, anchorY = 0) {
				return {
					x: scale * Math.cos(deg * (Math.PI / 180)) + anchorX,
					y: scale * Math.sin(deg * (Math.PI / 180)) + anchorY
				}
				// (sin(T * (pi/180) + X, cos(T * (pi/180) + Y)
			}
			function angleBetween2Points(x1, y1, x2, y2) {
				let dy = y2 - y1;
				let dx = x2 - x1;
				let theta = Math.atan2(dy, dx);
				theta *= 180 / Math.PI;
				// theta += 90;
				return theta;
			}

			function init() {

				let transaction = db.transaction(["projects"], "readonly");
				let objectStore = transaction.objectStore("projects");
				let index = objectStore.index("projectName");

				let huePickerGradient = new components.Image;
				huePickerGradient.fixedPosition = true;
				huePickerGradient.setSourcePath(hueSelectorURL);
				huePickerGradient.setSize(colourPickerSize, colourPickerSize);
				huePickerGradient.moveTo(Math.floor( Math.random() * engine.canvas.width ), Math.floor( Math.random() * engine.canvas.height ));
				engine.addObject(huePickerGradient);

				let huePicker = new components.Circle;
				huePicker.fixedPosition = true;
				huePicker.radius = 30;
				huePicker.outline.colour = "white";
				huePicker.colour = "red";
				huePicker.outline.size = 10;
				huePicker.moveTo( pointOnCircle(0, huePickerGradient.display.w/2 - huePicker.radius + huePicker.outline.size/2, huePickerGradient.display.x, huePickerGradient.display.y) );
				engine.addObject(huePicker);

				let angle = 0;

				// huePickerGradient.script = () => {

				// }

				huePicker.script = () => {
					
					if (
						huePicker.getAttribute("dragging") ||
						mouse.position.x > huePicker.display.x - huePicker.radius &&
						mouse.position.x < huePicker.display.x + huePicker.radius &&
						mouse.position.y > huePicker.display.y - huePicker.radius &&
						mouse.position.y < huePicker.display.y + huePicker.radius &&
						mouse.click_l
					) {
						let angle = angleBetween2Points(huePickerGradient.display.x, huePickerGradient.display.y, mouse.position.x, mouse.position.y);
						huePicker.moveTo( pointOnCircle(angle, huePickerGradient.display.w/2 - huePicker.radius + huePicker.outline.size/2, huePickerGradient.display.x, huePickerGradient.display.y) );
						let hue = -angle;
						hue %= 360;
						if (hue < 0) hue += 360;
						huePicker.colour = `hsl(${hue}deg, 100%, 50%)`;
						huePicker.setAttribute("dragging", mouse.click_l);
					}
				}

				let request = index.get(projectName);
				request.onsuccess = function (event) {
					let project = event.target.result;
					if (project) {
						project.layers.forEach(layer => {
							// let li = document.createElement("li");
							// li.textContent = `${file.filePath} - ${file.fileContent}`;
							// filesList.appendChild(li);
						});
					} else {
						console.log("Project not found");
					}
				};

				request.onerror = function (event) {
					console.error("Get project error: " + event.target.errorCode);
				};

				engine.setBackground("#F0F0F0");
			}
		</script>
	</body>

</html>